<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ML Job Crawler</title>
    <style>
      body {
        font-family: Inter, system-ui, sans-serif;
        margin: 0;
        background: #0f172a;
        color: #e2e8f0;
      }
      .container {
        max-width: 900px;
        margin: 32px auto;
        padding: 0 16px 40px;
      }
      .card {
        background: #111827;
        border: 1px solid #334155;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
      }
      h1 { margin-bottom: 6px; }
      .muted { color: #94a3b8; }
      .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
      input[type="password"] {
        flex: 1;
        min-width: 220px;
        background: #0b1220;
        color: #e2e8f0;
        border: 1px solid #475569;
        border-radius: 8px;
        padding: 10px;
      }
      button {
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 14px;
        cursor: pointer;
      }
      button:disabled { opacity: 0.55; cursor: not-allowed; }
      .progress-wrap {
        height: 16px;
        background: #1e293b;
        border-radius: 999px;
        overflow: hidden;
      }
      #progress-bar {
        height: 100%;
        width: 0;
        background: linear-gradient(90deg, #22c55e, #14b8a6);
        transition: width 0.3s ease;
      }
      .job {
        border: 1px solid #334155;
        background: #0b1220;
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 10px;
      }
      .job h3 { margin: 0 0 6px; }
      .job a { color: #93c5fd; }
      .pill { background: #1d4ed8; border-radius: 999px; padding: 2px 8px; font-size: 12px; }
      #logs { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 13px; max-height: 200px; overflow: auto; }
      #logs li { margin-bottom: 6px; }
      .fit { color: #86efac; font-weight: 600; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h1>ML Job Crawler</h1>
        <p class="muted">
          Crawl job boards for ML opportunities. Advanced mode runs a LangGraph-style deep research
          flow that uses your LLM API token to rank roles.
        </p>
      </div>

      <div class="card">
        <div class="row" style="margin-bottom: 10px">
          <label><input type="radio" name="mode" value="standard" checked /> Standard</label>
          <label><input type="radio" name="mode" value="advanced" /> Advanced (LangGraph + LLM)</label>
        </div>
        <div class="row" style="margin-bottom: 12px">
          <input id="llm-token" type="password" placeholder="LLM API token (required in advanced mode)" />
          <button id="start-btn">Start Crawl</button>
        </div>
        <div class="progress-wrap"><div id="progress-bar"></div></div>
        <p id="status" class="muted" style="margin-top: 8px">Idle.</p>
      </div>

      <div class="card">
        <h2 style="margin-top: 0">Progress log</h2>
        <ul id="logs"></ul>
      </div>

      <div class="card">
        <h2 style="margin-top: 0">Jobs found</h2>
        <div id="jobs"></div>
      </div>
    </div>

    <script>
      const startBtn = document.getElementById("start-btn");
      const tokenInput = document.getElementById("llm-token");
      const statusEl = document.getElementById("status");
      const logsEl = document.getElementById("logs");
      const jobsEl = document.getElementById("jobs");
      const progressBar = document.getElementById("progress-bar");

      let source;

      function selectedMode() {
        return document.querySelector("input[name='mode']:checked").value;
      }

      function setStatus(text) {
        statusEl.textContent = text;
      }

      function renderLogs(logs) {
        logsEl.innerHTML = "";
        logs.forEach((log) => {
          const li = document.createElement("li");
          li.textContent = `[${new Date(log.at).toLocaleTimeString()}] ${log.message}`;
          logsEl.appendChild(li);
        });
      }

      function renderJobs(jobs, mode) {
        jobsEl.innerHTML = "";
        if (jobs.length === 0) {
          jobsEl.innerHTML = '<p class="muted">No ML jobs found yet.</p>';
          return;
        }

        jobs.forEach((job) => {
          const card = document.createElement("div");
          card.className = "job";
          card.innerHTML = `
            <h3>${job.title}</h3>
            <div class="muted">${job.company} • ${job.location} • <span class="pill">${job.source}</span></div>
            <p>${job.summary || ""}</p>
            ${mode === "advanced" && job.fitScore ? `<p class="fit">Fit score: ${job.fitScore}/100</p>` : ""}
            ${mode === "advanced" && job.rationale ? `<p class="muted">${job.rationale}</p>` : ""}
            <a href="${job.url}" target="_blank" rel="noreferrer">View job</a>
          `;
          jobsEl.appendChild(card);
        });
      }

      function consumeEvent(data) {
        progressBar.style.width = `${data.progress}%`;
        setStatus(`${data.stage} — ${data.progress}% (${data.status})`);
        renderLogs(data.logs || []);
        renderJobs(data.jobs || [], data.mode);

        if (data.status === "completed" || data.status === "failed") {
          startBtn.disabled = false;
          if (source) source.close();
        }
      }

      startBtn.addEventListener("click", async () => {
        const mode = selectedMode();
        const llmToken = tokenInput.value.trim();

        if (mode === "advanced" && !llmToken) {
          alert("Advanced mode requires an LLM API token.");
          return;
        }

        startBtn.disabled = true;
        logsEl.innerHTML = "";
        jobsEl.innerHTML = "";
        progressBar.style.width = "0%";
        setStatus("Starting crawl...");

        const res = await fetch("/api/crawl/start", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mode, llmToken }),
        });

        if (!res.ok) {
          const err = await res.json();
          setStatus(err.error || "Unable to start crawl.");
          startBtn.disabled = false;
          return;
        }

        const { runId } = await res.json();
        source = new EventSource(`/api/crawl/events/${runId}`);
        source.onmessage = (event) => {
          consumeEvent(JSON.parse(event.data));
        };
        source.onerror = () => {
          setStatus("Connection lost while streaming progress.");
          startBtn.disabled = false;
          source.close();
        };
      });
    </script>
  </body>
</html>
